import os
import sqlite3
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import (
    Application, CommandHandler, MessageHandler, filters,
    ContextTypes, ConversationHandler
)

# ---------------------- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ----------------------
TOKEN = os.getenv("7891292032:AAFuMbeIJqwFGp690OmS7XTv95jAe33WEWk")
ADMIN_USERNAMES = ["MR_PR_001", "Forto_Support"]  # Ù„ÛŒØ³Øª Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§
SUPPORT_USERNAME = "Forto_Support"                # ÛŒÙˆØ²Ø±Ù†ÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ

# ---------------------- Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ----------------------
conn = sqlite3.connect("accounts.db", check_same_thread=False)
cursor = conn.cursor()
cursor.execute("""CREATE TABLE IF NOT EXISTS accounts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT,
    description TEXT,
    price TEXT,
    vbucks TEXT,
    stw TEXT,
    account_type TEXT,
    platform TEXT,
    warranty TEXT
)""")
conn.commit()

# ---------------------- Ù…Ø±Ø§Ø­Ù„ Ø§Ø¯Ù…ÛŒÙ† ----------------------
(NAME, DESCRIPTION, PRICE, VBUCKS, STW, ACCOUNT_TYPE, PLATFORM, WARRANTY) = range(8)

# ---------------------- Ø®ÙˆØ´ Ø¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ ----------------------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_first_name = update.message.from_user.first_name
    keyboard = [
        ["ğŸ›’ Ø®Ø±ÛŒØ¯ Ø§Ú©Ø§Ù†Øª", "ğŸ“ Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÛŒØ¯"],
        ["â„¹ï¸ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§", "ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ"],
        ["ğŸ“¦ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ù†"]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

    welcome_text = (
        f"ğŸ® Ø³Ù„Ø§Ù… {user_first_name}! Ø¨Ù‡ *ÙÙˆØ±ØªÙˆ Ø´Ø§Ù¾* Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ ğŸ‘‹\n\n"
        "ğŸ”¥ Ø¬Ø§ÛŒÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¨Ù‡ØªØ±ÛŒÙ† Ùˆ Ù…Ø·Ù…Ø¦Ù†â€ŒØªØ±ÛŒÙ† Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ ÙÙˆØ±ØªÙ†Ø§ÛŒØª Ø±Ùˆ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒ!\n\n"
        "âœ… Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ ØªØ¶Ù…ÛŒÙ†ÛŒ Ø¨Ø§ Ù‚ÛŒÙ…Øª Ù…Ù†Ø§Ø³Ø¨\n"
        "âœ… ØªØ­ÙˆÛŒÙ„ Ø³Ø±ÛŒØ¹\n"
        "âœ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Û²Û´ Ø³Ø§Ø¹ØªÙ‡\n\n"
        "Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù† ğŸ‘‡"
    )
    await update.message.reply_text(welcome_text, reply_markup=reply_markup, parse_mode="Markdown")

# ---------------------- Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† ----------------------
async def add_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.from_user.username not in ADMIN_USERNAMES:
        await update.message.reply_text("â›” Ø´Ù…Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ø§ÛŒÙ† Ú©Ø§Ø± Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.")
        return ConversationHandler.END
    await update.message.reply_text("Ù„Ø·ÙØ§Ù‹ Ø§Ø³Ù… Ø§Ú©Ø§Ù†Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
    return NAME

async def add_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['name'] = update.message.text
    await update.message.reply_text("ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ú©Ø§Ù†Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
    return DESCRIPTION

async def add_description(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['description'] = update.message.text
    await update.message.reply_text("Ù‚ÛŒÙ…Øª Ø§Ú©Ø§Ù†Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
    return PRICE

async def add_price(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['price'] = update.message.text
    await update.message.reply_text("ØªØ¹Ø¯Ø§Ø¯ V-Bucks Ø§Ú©Ø§Ù†Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
    return VBUCKS

async def add_vbucks(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['vbucks'] = update.message.text
    await update.message.reply_text("Ø¢ÛŒØ§ Ø§Ú©Ø§Ù†Øª Save the World Ø¯Ø§Ø±Ø¯ØŸ (Ø¨Ù„Ù‡ / Ø®ÛŒØ±)")
    return STW

async def add_stw(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['stw'] = update.message.text
    await update.message.reply_text("Ù†ÙˆØ¹ Ø§Ú©Ø§Ù†Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù‚Ø§Ù†ÙˆÙ†ÛŒ / Ú©Ø±Ú©ÛŒ):")
    return ACCOUNT_TYPE

async def add_account_type(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['account_type'] = update.message.text
    await update.message.reply_text("Ù¾Ù„ØªÙØ±Ù… Ø§Ú©Ø§Ù†Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (All / PS / Xbox / PCâ€¦):")
    return PLATFORM

async def add_platform(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['platform'] = update.message.text
    await update.message.reply_text("Ø¶Ù…Ø§Ù†Øª Ø§Ú©Ø§Ù†Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹ Ù…Ø§Ø¯Ø§Ù… / Û· Ø±ÙˆØ² / Ø¨Ø¯ÙˆÙ† Ø¶Ù…Ø§Ù†Øª):")
    return WARRANTY

async def add_warranty(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['warranty'] = update.message.text
    # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
    cursor.execute("""INSERT INTO accounts 
        (name, description, price, vbucks, stw, account_type, platform, warranty) 
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)""",
        (
            context.user_data['name'],
            context.user_data['description'],
            context.user_data['price'],
            context.user_data['vbucks'],
            context.user_data['stw'],
            context.user_data['account_type'],
            context.user_data['platform'],
            context.user_data['warranty']
        )
    )
    conn.commit()
    # Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ÛŒ
    summary = (
        f"âœ… Ø¢Ú¯Ù‡ÛŒ Ø§Ú©Ø§Ù†Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯:\n"
        f"Ø§Ø³Ù…: {context.user_data['name']}\n"
        f"ØªÙˆØ¶ÛŒØ­Ø§Øª: {context.user_data['description']}\n"
        f"Ù‚ÛŒÙ…Øª: {context.user_data['price']}\n"
        f"V-Bucks: {context.user_data['vbucks']}\n"
        f"Save the World: {context.user_data['stw']}\n"
        f"Ù†ÙˆØ¹ Ø§Ú©Ø§Ù†Øª: {context.user_data['account_type']}\n"
        f"Ù¾Ù„ØªÙØ±Ù…: {context.user_data['platform']}\n"
        f"Ø¶Ù…Ø§Ù†Øª: {context.user_data['warranty']}"
    )
    await update.message.reply_text(summary)
    return ConversationHandler.END

# ---------------------- Ù†Ù…Ø§ÛŒØ´ Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§ ----------------------
async def show_accounts(update: Update, context: ContextTypes.DEFAULT_TYPE):
    cursor.execute("SELECT * FROM accounts")
    accounts = cursor.fetchall()
    if not accounts:
        await update.message.reply_text("ğŸ“­ Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ø§Ú©Ø§Ù†ØªÛŒ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.")
        return
    text = "ğŸ›’ Ù„ÛŒØ³Øª Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯:\n\n"
    for acc in accounts:
        text += f"ğŸ”¹ {acc[1]} | {acc[3]} ØªÙˆÙ…Ø§Ù† | {acc[6]} | {acc[7]} | V-Bucks: {acc[4]} | STW: {acc[5]} | Ø¶Ù…Ø§Ù†Øª: {acc[8]}\n"
    await update.message.reply_text(text)

# ---------------------- Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÛŒØ¯ ----------------------
async def purchase_methods(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (
        "ğŸ’³ Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø§Ú©Ø§Ù†Øª Ø§Ø² ÙÙˆØ±ØªÙˆ Ø´Ø§Ù¾:\n\n"
        f"1ï¸âƒ£ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†: [@{SUPPORT_USERNAME}](https://t.me/{SUPPORT_USERNAME})\n"
        "2ï¸âƒ£ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø³Ø§ÛŒØª: ğŸŒ http://Fortoshop.ir\n"
        "3ï¸âƒ£ Ø®Ø±ÛŒØ¯ Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø² Ø®ÙˆØ¯ Ø±Ø¨Ø§Øª ğŸ›’"
    )
    await update.message.reply_text(text, parse_mode="Markdown")

# ---------------------- Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ----------------------
async def support(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(f"Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ… Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú© Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯:\nhttps://t.me/{SUPPORT_USERNAME}")

# ---------------------- main ----------------------
def main():
    app = Application.builder().token(TOKEN).build()

    # ConversationHandler Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("add", add_start)],
        states={
            NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, add_name)],
            DESCRIPTION: [MessageHandler(filters.TEXT & ~filters.COMMAND, add_description)],
            PRICE: [MessageHandler(filters.TEXT & ~filters.COMMAND, add_price)],
            VBUCKS: [MessageHandler(filters.TEXT & ~filters.COMMAND, add_vbucks)],
            STW: [MessageHandler(filters.TEXT & ~filters.COMMAND, add_stw)],
            ACCOUNT_TYPE: [MessageHandler(filters.TEXT & ~filters.COMMAND, add_account_type)],
            PLATFORM: [MessageHandler(filters.TEXT & ~filters.COMMAND, add_platform)],
            WARRANTY: [MessageHandler(filters.TEXT & ~filters.COMMAND, add_warranty)],
        },
        fallbacks=[]
    )
    app.add_handler(conv_handler)

    # Ø¯Ø³ØªÙˆØ±Ø§Øª Ùˆ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.Regex("ğŸ›’ Ø®Ø±ÛŒØ¯ Ø§Ú©Ø§Ù†Øª"), show_accounts))
    app.add_handler(MessageHandler(filters.Regex("ğŸ“ Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÛŒØ¯"), purchase_methods))
    app.add_handler(MessageHandler(filters.Regex("ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ"), support))

    app.run_polling()

if __name__ == "__main__":
    main()